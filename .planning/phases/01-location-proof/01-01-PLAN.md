---
phase: 01-location-proof
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [server/index.js]
autonomous: true
domain: nodejs-backend
---

<objective>
Audit current discovery functions and implement missing Skills API endpoint with full source tracking.

Purpose: Enable skill discovery from multiple locations (skill/, skills/, JSON config) with proper source attribution.
Output: Working `/api/skills` endpoint that aggregates skills from all sources with `source` field.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@server/index.js

## Current State Analysis

From server/index.js review:

**Already Implemented (Foundation Complete):**
- `getSkillDirs()` (lines 616-648): Already searches `skill/` and `skills/` with nested package structure
- `getSearchRoots()` (lines 583-614): Returns all config search locations
- Directory discovery functions return `{ path, source, root, package?, isFlat? }`

**Missing:**
- `/api/skills` endpoint - NOT present in current server/index.js
- Skills are only loaded via backup endpoint (lines 1377-1415) from single active directory

**Existing Pattern to Follow:**
- `/api/mcp` (lines 1029-1059): Uses Map for deduplication, prefers directory over JSON
- `/api/commands` (lines 1061-1092): Similar aggregation pattern

## Required Work

1. Create `loadSkillsFromDir()` function (similar to `loadCommandsFromDir`)
2. Create `aggregateSkills()` function for multi-source aggregation
3. Add `GET /api/skills` endpoint with source tracking
4. Verify existing `getSkillDirs()` properly handles all locations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create loadSkillsFromDir function</name>
  <files>server/index.js</files>
  <action>
Add `loadSkillsFromDir(dirInfo)` function after `loadMcpsFromDir()` (around line 775).

Function should:
- Read all subdirectories from dirInfo.path
- Check for SKILL.md file in each subdirectory
- Parse YAML frontmatter from SKILL.md (use existing `parseAgentMarkdown` pattern)
- Return array of skill objects with: name, content, description, source, path, root, metadata from frontmatter

Use same pattern as `loadCommandsFromDir()` (lines 697-735):
- Handle read errors gracefully with console.warn
- Parse frontmatter using existing yaml.load
- Extract description from metadata or content preview
- Include source from dirInfo.source

Do NOT modify existing getSkillDirs() - it's already correct.
  </action>
  <verify>grep -n "loadSkillsFromDir" server/index.js | head -5</verify>
  <done>Function exists and follows pattern of loadCommandsFromDir</done>
</task>

<task type="auto">
  <name>Task 2: Create aggregateSkills function and /api/skills endpoint</name>
  <files>server/index.js</files>
  <action>
Add two items after loadSkillsFromDir function:

1. `aggregateSkills()` function:
   - Call getSkillDirs() to get all skill directories
   - For each dir, call loadSkillsFromDir()
   - Collect all skills into array with source tracking
   - Load skills from opencode.json configs (check config.skills array)
   - Deduplicate: prefer skills-dir > skill-dir > json-config
   - Return aggregated array

2. `GET /api/skills` endpoint (before /api/agents):
   ```javascript
   app.get('/api/skills', (req, res) => {
     try {
       const skills = aggregateSkills();
       res.json(skills);
     } catch (err) {
       res.status(500).json({ error: err.message });
     }
   });
   ```

Deduplication logic (use Map like /api/mcp):
- If same skill name from multiple sources
- Priority: 'skills-dir' (3) > 'skill-dir' (2) > 'json-config' (1)
- First source wins if same priority
  </action>
  <verify>curl -s http://localhost:1920/api/skills | jq '.[0] | {name, source}'</verify>
  <done>Endpoint returns skills array with source field for each item</done>
</task>

</tasks>

<verification>
Before declaring complete:
- [ ] Server starts without errors: `cd server && node index.js`
- [ ] Test endpoint: `curl -s http://localhost:1920/api/skills`
- [ ] Verify source field present: Each skill has `source` ('skill-dir', 'skills-dir', or 'json-config')
- [ ] Test with directory structure: Create `~/.config/opencode/skill/test-skill/SKILL.md`
- [ ] Verify skill appears with correct source
</verification>

<success_criteria>
- loadSkillsFromDir() function created following existing patterns
- aggregateSkills() function implements multi-source aggregation
- GET /api/skills endpoint returns array of all discovered skills
- Each skill has source field indicating origin
- Deduplication prefers directory sources over JSON config
- Server starts and responds correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-location-proof/01-01-SUMMARY.md`
</output>

## Questions for Next Phase
- Should skills have write endpoints (POST/PUT/DELETE) like agents do?
- How should skill editing work for skills from different sources?
