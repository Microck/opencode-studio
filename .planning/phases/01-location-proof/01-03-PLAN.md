---
phase: 01-location-proof
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [server/index.js]
autonomous: true
domain: nodejs-backend
---

<objective>
Update Agents API for complete multi-location aggregation with source tracking.

Purpose: Ensure agents are discovered from all search roots (not just active config directory) with proper source attribution.
Output: Enhanced `/api/agents` endpoint aggregating agents from all locations.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@server/index.js

## Current State Analysis

From server/index.js review (lines 1094-1153):

**Current Implementation:**
- `getAgentDirs()` (lines 776-788): Already searches multiple locations including `.opencode/agents`
- `/api/agents` GET endpoint exists
- Loads agents from:
  1. `config.agent` (JSON config)
  2. Markdown files in agent directories
  3. Built-in agents ('build', 'plan')

**Issues Found:**
1. **Partial Aggregation**: `getAgentDirs()` returns paths, but the endpoint only checks `config.agent` from single `loadConfig()` call
2. **No Source Tracking**: Agents don't have `source` field indicating origin
3. **Inconsistent Pattern**: Unlike /api/mcp and /api/commands which use `loadAggregatedConfig()`, agents don't aggregate from all search roots

**What's Needed:**
- Aggregate agents from ALL opencode.json files across search roots
- Add source field: 'json-config', 'markdown', 'builtin'
- Maintain backward compatibility with existing agent loading

## Current Agent Loading (Lines 1094-1153)

```javascript
// Currently loads from single config:
const config = loadConfig() || {};  // Only active config!
const configAgents = config.agent || {};

// Then loads from markdown dirs:
for (const dir of getAgentDirs()) {
  // ... loads .md files
}
```

Should aggregate from all configs like `loadAggregatedConfig()` does for MCPs.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create aggregateAgents function with multi-source support</name>
  <files>server/index.js</files>
  <action>
Add `aggregateAgents()` function before the /api/agents endpoint.

Function should:
1. Initialize Map for deduplication (name -> agent)
2. Aggregate JSON agents from ALL search roots:
   - Use getSearchRoots() to get all roots
   - For each root, check for opencode.json
   - Parse config.agent object
   - Add each agent with source: 'json-config', configPath: root
3. Load markdown agents from all agent directories:
   - Use existing getAgentDirs()
   - For each dir, read .md files
   - Parse frontmatter with parseAgentMarkdown()
   - Add with source: 'markdown', path: filepath
   - If agent already exists from JSON, skip (directory preferred)
4. Add built-in agents ('build', 'plan') if not present
   - source: 'builtin'
5. Return Array.from(agentMap.values())

Priority for deduplication:
- Markdown agents preferred over JSON (user can override built-ins)
- JSON agents from any location (first wins if same name)
- Built-in agents only if no user-defined agent with same name

Keep existing agent structure (name, description, mode, model, etc.).
  </action>
  <verify>grep -n "aggregateAgents" server/index.js | head -5</verify>
  <done>Function exists and aggregates from all search roots</done>
</task>

<task type="auto">
  <name>Task 2: Update /api/agents endpoint to use aggregateAgents</name>
  <files>server/index.js</files>
  <action>
Update the existing `GET /api/agents` endpoint (lines ~1094-1153):

Replace current implementation with:
```javascript
app.get('/api/agents', (req, res) => {
  try {
    const studio = loadStudioConfig();
    const disabledAgents = studio.disabledAgents || [];
    
    const agents = aggregateAgents();
    
    // Add disabled status from studio config
    const agentsWithStatus = agents.map(agent => ({
      ...agent,
      disabled: disabledAgents.includes(agent.name)
    }));
    
    res.json({ agents: agentsWithStatus });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});
```

The aggregateAgents() function should handle:
- Loading from all JSON configs
- Loading from all markdown directories
- Adding built-in agents
- Setting source field for each

Remove the old inline loading logic (move to aggregateAgents).
Ensure backward compatibility: response format { agents: [...] } stays same.
  </action>
  <verify>curl -s http://localhost:1920/api/agents | jq '.agents[0] | {name, source}'</verify>
  <done>Endpoint returns agents with source field from all locations</done>
</task>

</tasks>

<verification>
Before declaring complete:
- [ ] Server starts without errors
- [ ] Test endpoint: `curl -s http://localhost:1920/api/agents | jq '.agents | length'`
- [ ] Verify source field present: Each agent has `source` ('json-config', 'markdown', or 'builtin')
- [ ] Verify built-in agents present: 'build' and 'plan' agents exist
- [ ] Test with markdown agent: Create `~/.config/opencode/agents/test-agent.md`
- [ ] Verify agent appears with source: 'markdown'
- [ ] Verify disabled status still works from studio config
</verification>

<success_criteria>
- aggregateAgents() function created aggregating from all search roots
- GET /api/agents uses aggregateAgents() instead of single config
- Each agent has source field indicating origin
- Deduplication prefers markdown over JSON over built-in
- Built-in agents ('build', 'plan') still included
- Response format remains { agents: [...] } for backward compatibility
- Disabled status from studio config still applied
- Server starts and responds correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-location-proof/01-03-SUMMARY.md`
</output>
