---
phase: 01-location-proof
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [server/index.js]
autonomous: true
domain: nodejs-backend
---

<objective>
Implement Plugins API endpoint with multi-location discovery and source tracking.

Purpose: Enable plugin discovery from plugin/, plugins/, and JSON config with source attribution.
Output: Working `/api/plugins` endpoint that aggregates plugins from all sources.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@server/index.js

## Current State Analysis

From server/index.js review:

**Already Implemented (Foundation Complete):**
- `getPluginDirs()` (lines 678-695): Already searches `plugin/` and `plugins/`
- Returns array of `{ path, source, root }` objects

**Missing:**
- `/api/plugins` endpoint - NOT present in current server/index.js
- `loadPluginsFromDir()` function - NOT present
- Plugins only loaded via backup endpoint (lines 1393-1402) from single active directory

**Existing Pattern to Follow:**
- `/api/mcp` (lines 1029-1059): Uses Map for deduplication
- `/api/commands` (lines 1061-1092): Similar aggregation
- `loadCommandsFromDir()` (lines 697-735): File reading pattern

## Plugin Structure

Plugins are JS/TS files in plugin directories:
- `~/.config/opencode/plugin/my-plugin.js` (or .ts)
- `~/.config/opencode/plugins/my-plugin.js` (or .ts)

Each plugin file should export a default object with metadata.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create loadPluginsFromDir function</name>
  <files>server/index.js</files>
  <action>
Add `loadPluginsFromDir(dirInfo)` function after `loadSkillsFromDir()`.

Function should:
- Read all files from dirInfo.path (not subdirectories like skills)
- Filter for .js and .ts files
- For each file, read content and extract name (basename without ext)
- Return array of plugin objects with:
  - name: filename without extension
  - filename: full filename
  - content: file content as string
  - source: dirInfo.source
  - path: full file path
  - root: dirInfo.root

Use pattern similar to `loadCommandsFromDir()` but simpler (no frontmatter parsing for plugins):
- Handle read errors gracefully with console.warn
- Check fs.existsSync before reading
- Filter: f.endsWith('.js') || f.endsWith('.ts')

Note: Unlike skills (subdirectories), plugins are direct files in the plugin directory.
  </action>
  <verify>grep -n "loadPluginsFromDir" server/index.js | head -5</verify>
  <done>Function exists and reads .js/.ts files from plugin directories</done>
</task>

<task type="auto">
  <name>Task 2: Create aggregatePlugins function and /api/plugins endpoint</name>
  <files>server/index.js</files>
  <action>
Add two items:

1. `aggregatePlugins()` function:
   - Call getPluginDirs() to get all plugin directories
   - For each dir, call loadPluginsFromDir()
   - Collect all plugins into array
   - Load plugins from opencode.json (check config.plugins array)
   - Deduplicate with priority: plugins-dir > plugin-dir > json-config
   - Return aggregated array

2. `GET /api/plugins` endpoint (after /api/skills):
   ```javascript
   app.get('/api/plugins', (req, res) => {
     try {
       const plugins = aggregatePlugins();
       res.json(plugins);
     } catch (err) {
       res.status(500).json({ error: err.message });
     }
   });
   ```

Deduplication:
- Use Map with plugin.name as key
- Priority: 'plugins-dir' (3) > 'plugin-dir' (2) > 'json-config' (1)
- If same priority, first encountered wins

For JSON config plugins, transform to same shape:
- config.plugins is array of objects with name, path, etc.
- Add source: 'json-config' to each
  </action>
  <verify>curl -s http://localhost:1920/api/plugins | jq '.[0] | {name, source}'</verify>
  <done>Endpoint returns plugins array with source field for each item</done>
</task>

</tasks>

<verification>
Before declaring complete:
- [ ] Server starts without errors
- [ ] Test endpoint: `curl -s http://localhost:1920/api/plugins`
- [ ] Verify source field present: Each plugin has `source` ('plugin-dir', 'plugins-dir', or 'json-config')
- [ ] Test with file: Create `~/.config/opencode/plugin/test-plugin.js` with content
- [ ] Verify plugin appears with correct source and content
</verification>

<success_criteria>
- loadPluginsFromDir() function created following existing patterns
- aggregatePlugins() function implements multi-source aggregation
- GET /api/plugins endpoint returns array of all discovered plugins
- Each plugin has source field indicating origin
- Deduplication prefers plugins-dir > plugin-dir > json-config
- Server starts and responds correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-location-proof/01-02-SUMMARY.md`
</output>
