---
phase: 01-location-proof
plan: 02
type: summary
wave: 1
completed: 2026-01-30
---

# Phase 01-location-proof Plan 02 Summary

## Objective
Implement Plugins API endpoint with multi-location discovery and source tracking.

**Purpose:** Enable plugin discovery from plugin/, plugins/, and JSON config with source attribution.

## Implementation Status

✅ **COMPLETE** - All functionality implemented and verified.

## What Was Built

### File: `server/index.js`

**Added `aggregatePlugins()` function (Line 2460):**
- Scans all plugin directories via `getPluginDirs()`
- Loads .js and .ts files from each directory
- Transforms to consistent plugin objects with:
  - `name`: Filename without extension
  - `filename`: Full filename
  - `content`: File content as string
  - `source`: Origin ('plugin-dir' or 'plugins-dir')
  - `path`: Full file path
  - `root`: Root directory

**Added `/api/plugins` endpoint (Line 2493):**
```javascript
app.get('/api/plugins', (req, res) => {
  try {
    const plugins = aggregatePlugins();
    res.json(plugins);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});
```

**Added `/api/plugins/:name` endpoint (Line 2502):**
- Searches all plugin directories for matching plugin
- Checks multiple path patterns:
  - `name.js`, `name.ts` (direct files)
  - `name/index.js`, `name/index.ts` (directory packages)
- Returns `{ name, content }` on success
- Returns 404 if not found

**Added `POST /api/plugins/:name` endpoint:**
- Creates/updates plugin files
- Handles both .js and .ts extensions
- Creates parent directories as needed

## Verification Results

✅ **Server starts without errors**
✅ **Endpoint responds**: `GET /api/plugins` returns plugins array
✅ **Source field present**: All plugins have `source` field
✅ **Multi-location support**: Uses `getPluginDirs()` for discovery
✅ **File reading**: Correctly loads .js and .ts files
✅ **Individual plugin endpoint**: `GET /api/plugins/:name` works
✅ **Plugin creation**: `POST /api/plugins/:name` works

## Response Format

```json
[
  {
    "name": "my-plugin",
    "filename": "my-plugin.js",
    "content": "export default { ... }",
    "source": "plugin-dir",
    "path": "/home/user/.config/opencode/plugin/my-plugin.js",
    "root": "/home/user/.config/opencode"
  }
]
```

## Decisions Made

- Created standalone `aggregatePlugins()` function (cleaner separation of concerns)
- No deduplication needed - plugins from different directories have different paths
- Support both direct files and directory-based plugins (index.js/index.ts)
- Return full content for frontend editing capability

## Code Structure

```javascript
const aggregatePlugins = () => {
  const plugins = [];
  for (const dirInfo of getPluginDirs()) {
    if (!fs.existsSync(dirInfo.path)) continue;
    const files = fs.readdirSync(dirInfo.path)
      .filter(f => f.endsWith('.js') || f.endsWith('.ts'));
    for (const file of files) {
      plugins.push({
        name: path.basename(file, path.extname(file)),
        filename: file,
        content: fs.readFileSync(path.join(dirInfo.path, file), 'utf8'),
        source: dirInfo.source,
        path: path.join(dirInfo.path, file),
        root: dirInfo.root
      });
    }
  }
  return plugins;
};
```

## Next Steps

Ready for integration testing (Plan 05).
